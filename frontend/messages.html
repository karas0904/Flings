<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Messages - Amourette</title>
    <link rel="icon" type="image/svg" href="assets/icons/Logo.svg" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Raleway:wght@400&display=swap"
      rel="stylesheet"
    />
    <script src="http://127.0.0.1:3000/socket.io/socket.io.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background: #000;
        height: 100vh;
        display: flex;
        position: relative;
        overflow: hidden;
      }

      .loading {
        font-size: 16px;
        color: rgba(255, 255, 255, 0.8);
        text-align: center;
        padding: 20px;
      }

      .loading span {
        opacity: 0;
        animation: dotFade 1.5s infinite;
      }

      .loading span:nth-child(1) {
        animation-delay: 0s;
      }

      .loading span:nth-child(2) {
        animation-delay: 0.5s;
      }

      .loading span:nth-child(3) {
        animation-delay: 1s;
      }

      @keyframes dotFade {
        0% {
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      .blur-shape {
        position: fixed;
        width: 250px;
        height: 500px;
        border-radius: 50px;
        filter: blur(100px);
        z-index: -2;
        opacity: 0.2;
      }

      .red-shape {
        background: rgba(255, 0, 0, 0.7);
        top: 10%;
        left: 5%;
        transform: rotate(45deg);
      }

      .blue-shape {
        background: rgba(135, 206, 250, 0.7);
        bottom: -150px;
        right: -1%;
        transform: rotate(45deg);
      }

      .container {
        display: flex;
        width: 100%;
        height: 100vh;
        position: relative;
      }

      .left-sidebar {
        width: 60px;
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px 0;
        color: #fff;
        position: relative;
      }

      .left-sidebar::after {
        content: "";
        position: absolute;
        right: 0;
        top: 0;
        width: 0.5px;
        height: 100%;
        background: linear-gradient(
          to bottom,
          rgba(255, 251, 251, 0) 0%,
          rgba(255, 255, 255, 0) 20%,
          rgba(255, 255, 255, 0.8) 50%,
          rgba(255, 255, 255, 0) 80%,
          rgba(255, 255, 255, 0) 100%
        );
      }

      .left-sidebar .logo {
        font-size: 14px;
        font-weight: bold;
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        margin-bottom: 40px;
      }

      .left-sidebar .icons-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        justify-content: center;
      }

      .left-sidebar .icon-btn {
        font-size: 24px;
        color: rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: color 0.3s, filter 0.3s, background-color 0.3s;
      }

      .left-sidebar .icon-btn:hover {
        color: #fff;
        background: rgba(255, 255, 255, 0.3);
      }

      .heart-icon:hover {
        color: rgb(255, 52, 52);
        transition: 0.5s;
      }

      .left-sidebar .separator {
        width: 20px;
        height: 1px;
        background: rgba(255, 255, 255, 0.5);
        margin: 10px 0;
      }

      .left-sidebar .profile-icon {
        font-size: 24px;
        color: #fff;
        cursor: pointer;
        transition: none;
        margin-top: 40px;
      }

      .left-sidebar .profile-icon:hover {
        color: #fff;
      }

      .messages-list {
        width: 300px;
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 20px;
        color: #fff;
        overflow-y: auto;
        position: relative;
      }

      .messages-list::after {
        content: "";
        position: absolute;
        right: 0;
        top: 0;
        width: 0.5px;
        height: 100%;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0) 0%,
          rgba(255, 255, 255, 0) 20%,
          rgba(255, 255, 255, 0.8) 50%,
          rgba(255, 255, 255, 0) 80%,
          rgba(255, 255, 255, 0) 100%
        );
      }

      .custom-dropdown {
        position: relative;
        margin-bottom: 20px;
      }

      .dropdown-header {
        display: flex;
        flex-direction: column;
        font-size: 20px;
        font-weight: bold;
        color: #fff;
        cursor: pointer;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        transition: background 0.3s ease, box-shadow 0.3s ease,
          height 0.3s ease-in-out;
        overflow: hidden;
        height: 44px; /* Initial height (matches padding + content) */
        position: relative;
      }

      .dropdown-header:hover {
        background: rgba(255, 255, 255, 0.2);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      }

      .dropdown-header.active {
        height: 88px; /* Expanded height to show one item (adjust if more items) */
      }

      .dropdown-header .top-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
      }

      .dropdown-items {
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
      }

      .dropdown-header.active .dropdown-items {
        max-height: 44px; /* Height for one item (adjust if more items) */
        opacity: 1;
      }

      .dropdown-item:hover {
        color: #fff;
        background: rgba(255, 255, 255, 0.136);
        border-radius: 10px;
      }

      .dropdown-item {
        padding: 10px;
        font-size: 16px;
        margin-top: 5px;
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        transition: color 0.3s, background 0.3s;
      }

      .dropdown-header .arrow {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.8);
        transition: transform 0.3s ease-in-out;
      }

      .dropdown-header .arrow.active {
        transform: rotate(180deg);
      }

      .dropdown-menu {
        position: absolute;
        top: 100%; /* Align directly below the header */
        left: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.1); /* Match header background */
        backdrop-filter: blur(10px); /* Consistent blur effect */
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(103, 103, 103, 0.477); /* Match header border */
        border-top: none; /* Remove top border to blend with header */
        border-radius: 0 0 5px 5px; /* Round only bottom corners */
        overflow: hidden;
        opacity: 0;
        transform: translateY(-10px) scaleY(0.9); /* Start slightly above and scaled */
        transform-origin: top; /* Anchor animation at the top */
        pointer-events: none;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        z-index: 10;
      }

      .dropdown-menu.active {
        opacity: 1;
        transform: translateY(0) scaleY(1); /* Slide down and scale to full size */
        pointer-events: auto;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Match headerâ€™s shadow */
      }

      .dropdown-menu .dropdown-item {
        padding: 10px;
        font-size: 16px;
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        transition: color 0.3s, background 0.3s;
      }

      .dropdown-menu .dropdown-item:hover {
        color: #fff;
        background: rgba(255, 255, 255, 0.2);
      }

      .messages-list .search-bar {
        width: 100%;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 5px;
        color: #fff;
        font-size: 14px;
        margin-bottom: 20px;
        transition: box-shadow 0.3s ease-in-out;
      }

      .messages-list .search-bar:focus {
        outline: none;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      }

      .messages-list .search-bar::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .message-item {
        display: flex;
        align-items: center;
        padding: 10px 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: background 0.3s;
      }

      .message-item:hover {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .message-item .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        margin-right: 10px;
        overflow: hidden;
      }

      .message-item .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
      }

      .message-item .details {
        flex: 1;
      }

      .message-item .details .name {
        font-size: 16px;
        font-weight: bold;
        display: flex; /* Use flex to align items */
        align-items: center; /* Center items vertically */
        justify-content: space-between; /* Space between name and time */
      }

      .message-item .details .name-time {
        display: flex; /* Use flexbox to align name and time */
        justify-content: space-between; /* Space between name and time */
        align-items: center; /* Center items vertically */
      }

      .message-item .details .time {
        font-size: 12px; /* Adjust font size for time */
        color: rgba(255, 255, 255, 0.6); /* Color for time */
        margin-left: 8px; /* Space between name and time */
        flex-shrink: 0; /* Prevent time from shrinking */
      }

      .message-item .details .snippet {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 2px;
      }

      .message-item .details .comment {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 2px;
      }

      .message-item.simplified {
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: background 0.3s;
      }

      .message-item.simplified:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .message-item.simplified .name {
        font-size: 16px;
        font-weight: bold;
      }

      .chat-section {
        flex: 1;
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        padding: 20px;
        color: #fff;
        position: relative;
        height: 100%;
      }

      .blur-container {
        display: flex;
        flex-direction: column;
        flex: 1;
        transition: filter 0.3s;
        min-height: 0;
      }

      .blur-container.blur {
        filter: blur(5px);
      }

      .chat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .chat-header .user-info {
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: opacity 0.3s ease;
      }

      .chat-header .user-info:hover {
        opacity: 0.8;
      }

      .chat-header .user-info .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        margin-right: 10px;
        overflow: hidden;
      }

      .chat-header .user-info .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
      }

      .chat-header .user-info .name {
        font-size: 18px;
        font-weight: bold;
      }

      .chat-header .user-info .status {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        margin-left: 5px;
      }

      .chat-header .user-info .status.default {
        font-style: italic;
        opacity: 0.4;
      }

      .chat-header .actions {
        display: none; /* Hide by default */
        gap: 10px;
        position: relative;
      }

      .chat-header .actions.visible {
        display: flex; /* Show when active */
      }

      .chat-header .actions .icon {
        font-size: 20px;
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        transition: color 0.3s;
      }

      .chat-header .actions .icon:hover {
        color: #fff;
      }

      .chat-cleared-message {
        font-family: "Raleway", sans-serif;
        font-size: 16px; /* Adjust as needed */
        color: #666; /* Subtle color for the message */
        margin: 0;
        padding: 20px;
        text-align: center;
      }

      .chat-body {
        flex: 1;
        padding: 20px 0;
        overflow-y: auto;
        min-height: 0;
        display: block; /* Ensures block-level container */
        width: 100%; /* Full width for alignment */
      }

      .chat-footer {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 50px;
        position: relative;
        margin-top: auto;
        flex-shrink: 0;
      }

      .chat-footer .message-input {
        flex: 1;
        padding: 10px;
        outline: none;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 5px;
        color: #fff;
        font-size: 14px;
        transition: box-shadow 0.3s ease-in-out;
      }

      .chat-footer .message-input:focus {
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      }

      .chat-footer .message-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .chat-footer .send-btn {
        font-size: 20px;
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        transition: color 0.3s;
        padding-left: 8px;
        padding-top: 6px;
      }

      .chat-footer .send-btn:hover {
        color: #fff;
      }

      .send-btn {
        background-color: transparent;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        justify-content: center; /* Center the icon horizontally */
        align-items: center; /* Center the icon vertically */
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.3s ease;
      }

      .send-btn:hover {
        background-color: rgb(188, 188, 188);
        transform: scale(1.1);
        color: black;
        transition: 0.5s;
      }

      .plus-btn {
        font-size: 20px;
        color: rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.5s ease-in-out, color 0.3s,
          background-color 0.3s;
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 10;
      }

      .plus-btn:hover {
        color: #fff;
        background: rgba(255, 255, 255, 0.3);
      }

      .plus-btn.active {
        transform: rotate(45deg);
      }

      .options-menu {
        position: absolute;
        bottom: 80px;
        left: 20px;
        display: flex;
        flex-direction: column; /* Change to column to stack buttons */
        gap: 10px; /* Space between buttons */
        background: transparent;
        backdrop-filter: none;
        padding: 10px;
        border-radius: 5px;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        pointer-events: none;
        z-index: 10;
      }

      .options-menu.active {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .options-menu button {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.8);
        background: transparent;
        border: none;
        padding: 10px;
        text-align: left;
        cursor: pointer;
        transition: color 0.3s;
        font-weight: bold;
        width: 100%; /* Ensure buttons take full width */
      }

      .options-menu button:hover {
        color: #fff;
      }

      .profile-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        overflow: hidden;
        margin-top: auto;
        margin-bottom: 20px;
        box-sizing: border-box;
      }

      .profile-icon img {
        width: 100%;
        height: 100%;
        object-fit: cover; /* Ensures the image fills the circle without distortion */
        display: block;
        border-radius: 50%;
      }

      .profile-icon:hover {
        outline: 5px solid rgba(144, 136, 136, 0.432);
        transition: 0.5s;
      }

      .message {
        position: relative; /* Add this to make it a positioning context */
        display: inline-block; /* Shrinks to content width, stacks vertically */
        max-width: 70%; /* Limits long messages */
        margin: 5px 10px; /* Reduced vertical margin, keep horizontal */
        padding: 8px 12px; /* Tight padding */
        border-radius: 20px;
        word-wrap: break-word;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .message p {
        margin: 0; /* Remove default margins */
        padding: 0; /* Remove padding */
        display: inline; /* Prevents stretching */
        line-height: 1.2; /* Ensures text height is natural */
      }

      .message.sent {
        background: #26a69a; /* Soft teal for a calming, attractive look */
        float: right;
        border-bottom-right-radius: 2px;
        text-align: left;
        clear: both;
      }

      .message.received {
        background: rgba(255, 255, 255, 0.2);
        float: left; /* Aligns left */
        border-bottom-left-radius: 5px;
        text-align: left;
        clear: both; /* Ensures stacking */
      }

      .message:hover {
        transform: translateY(-2px); /* Slight lift */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Enhanced shadow */
      }

      .message .timestamp {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.8);
        display: block; /* Below message text */
        text-align: right;
        margin-top: 2px;
        line-height: 1; /* Prevents extra height */
      }

      .chat-actions-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        width: 200px;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        pointer-events: none;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out,
          visibility 0.3s ease-in-out;
        z-index: 1000;
      }

      .chat-actions-dropdown.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
      }

      .chat-actions-dropdown .action-item {
        padding: 10px 15px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        transition: background 0.3s, color 0.3s;
        overflow: visible;
      }

      .chat-actions-dropdown .action-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      .remove-btn {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.8);
        font-size: 16px;
        cursor: pointer;
        padding: 0 10px;
        transition: color 0.3s ease;
      }

      .remove-btn:hover {
        color: #ff4d4d;
      }

      .message-item.simplified {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: default;
      }

      .message-item.simplified .name {
        flex: 1;
      }

      .efforts-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-end; /* Already updated to push content down */
        align-items: stretch; /* Changed from center to stretch content horizontally */
        height: 100%;
        z-index: 5;
        padding-bottom: 20px; /* Keep this for spacing from bottom */
      }

      .efforts-content {
        text-align: center;
        color: #fff;
        font-size: 12px;
        font-style: italic;
        padding: 20px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        width: 100%; /* Full width */
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 10px; /* Space between elements */
      }

      .efforts-actions {
        display: flex;
        gap: 20px;
        margin-top: 20px;
      }

      .efforts-message {
        max-width: 70%;
        margin: 10px 10px 10px auto; /* Align to the right with margin */
        padding: 10px 15px;
        border-radius: 15px;
        background: rgba(
          255,
          52,
          52,
          0.852
        ); /* Reddish background with transparency */
        position: relative;
        text-align: left; /* Text inside remains left-aligned */
        color: #fff;
        border-bottom-right-radius: 5px; /* Mimic sent message style */
      }

      .efforts-message .comment-text {
        margin: 0;
      }

      .efforts-message .timestamp {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.5);
        position: absolute;
        bottom: -15px;
        right: 5px;
      }

      .accept-btn {
        background-color: #30363b; /* Green background */
        color: #28a745; /* White text */
        padding: 8px 26px; /* Add some padding for better appearance */
        border: none; /* Remove default border */
        border-radius: 40px; /* Rounded corners */
        cursor: pointer; /* Hand cursor on hover */
        font-weight: bold; /* Bold text */
        transition: background-color 0.3s ease, transform 0.2s ease; /* Smooth transitions */
      }

      .accept-btn:hover {
        background-color: #218838; /* Darker green on hover */
        transform: scale(1.05); /* Slight scale-up effect */
        color: #ffff;
      }

      .reject-btn {
        background-color: #30363b; /* Dark greyish background */
        color: #dc3545; /* Reddish text */
        padding: 8px 26px; /* Consistent padding */
        border: none; /* Remove default border */
        border-radius: 40px; /* Rounded corners */
        cursor: pointer; /* Hand cursor on hover */
        font-weight: bold; /* Bold text */
        transition: background-color 0.3s ease, transform 0.2s ease; /* Smooth transitions */
      }

      .reject-btn:hover {
        background-color: #dc3545; /* Slightly lighter grey on hover */
        color: #ffff; /* Darker red text on hover */
        transform: scale(1.05); /* Slight scale-up effect */
      }

      /* Ensure the efforts-actions container spaces the buttons nicely */
      .efforts-actions {
        display: flex;
        gap: 20px; /* Space between buttons */
        justify-content: center; /* Center the buttons */
        margin-top: 20px; /* Space above the buttons */
      }

      .score-info {
        text-align: center;
        font-size: 14px;
        color: #666;
        margin: 10px 0;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 5px;
      }
      .score-info p {
        margin: 2px 0;
      }
      .fun-line {
        color: #ff69b4; /* Hot pink */
        font-style: italic;
      }
      .kink-line {
        color: #800080; /* Purple */
        font-weight: bold;
      }

      /* Message Context Menu Styles */
      .message-context-menu {
        position: fixed;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 8px;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        min-width: 150px;
        transition: opacity 0.2s ease, transform 0.2s ease;
        opacity: 0;
        transform: scale(0.95);
      }

      .message-context-menu.visible {
        opacity: 1;
        transform: scale(1);
      }

      .context-menu-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        color: #fff;
        cursor: pointer;
        border-radius: 8px;
        transition: background-color 0.2s;
      }

      .context-menu-option:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .context-menu-option i {
        font-size: 16px;
        width: 20px;
        text-align: center;
      }

      /* Emoji Reaction Panel */
      .emoji-reaction-panel {
        position: fixed;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 24px;
        padding: 8px;
        display: none;
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
        z-index: 999;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: opacity 0.2s ease, transform 0.2s ease;
        opacity: 0;
        transform: scale(0.95);
      }

      .emoji-reaction-panel.visible {
        opacity: 1;
        transform: scale(1);
      }

      .emoji-option {
        font-size: 20px;
        padding: 8px;
        cursor: pointer;
        text-align: center;
        border-radius: 50%;
        transition: transform 0.2s, background-color 0.2s;
      }

      .emoji-option:hover {
        background-color: rgba(255, 255, 255, 0.1);
        transform: scale(1.2);
      }

      /* Message Reaction Styles */
      .message-reactions {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 4px;
      }

      .reaction {
        font-size: 14px;
        padding: 2px 6px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .reaction-count {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
      }

      /* Add styles for message reactions */
      .message .location-link {
        display: inline-flex; /* Flex for aligning icon and text */
        align-items: center; /* Center icon and text vertically */
        color: #012343 !important; /* Vibrant blue */
        text-decoration: none; /* No underline on the link itself */
        font-weight: 500; /* Medium weight */
        font-size: 14px; /* Compact */
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 12px;
        background: linear-gradient(
          135deg,
          rgba(77, 168, 255, 0.15),
          rgba(77, 168, 255, 0.05)
        );
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3),
          inset 0 1px 1px rgba(255, 255, 255, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .message .location-link .link-text {
        text-decoration: underline; /* Underline only the text */
      }

      .message .location-link:hover {
        color: #ffffff !important;
        background: linear-gradient(
          135deg,
          rgba(77, 168, 255, 0.3),
          rgba(77, 168, 255, 0.1)
        );
        box-shadow: 0 4px 12px rgba(77, 168, 255, 0.4),
          inset 0 1px 1px rgba(255, 255, 255, 0.2);
        transform: translateY(-1px) scale(1.02);
      }

      .message .location-link:active {
        transform: translateY(0) scale(0.98);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .message .location-link::before {
        content: "ðŸ“";
        margin-right: 6px;
        font-size: 14px;
        line-height: 1;
        transition: transform 0.3s ease;
      }

      .message .location-link:hover::before {
        transform: scale(1.2) rotate(10deg);
      }

      .message .location-link::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s ease;
      }

      .message .location-link:hover::after {
        left: 100%;
      }

      /* Ensure parent elements don't block clicks */
      .message p {
        pointer-events: auto;
      }

      /* Ensure parent elements don't block clicks */
      .message p {
        pointer-events: auto;
      }

      .chat-body.blur > *:not(.active-message) {
        filter: blur(3px);
        transition: filter 0.3s ease;
      }

      .active-message {
        position: relative;
        z-index: 2;
      }

      .deleted-message {
        font-style: italic;
        color: rgba(255, 255, 255, 0.5);
      }

      /* Add these styles to your existing CSS */
      .action-item {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        overflow: visible; /* Allow child elements to overflow */
      }

      .info-icon {
        margin-left: 8px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.6);
        cursor: pointer;
        position: relative;
      }

      .tooltip {
        position: absolute;
        left: 50%;
        top: 100%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        width: max-content; /* Allow content to determine width */
        max-width: 200px; /* Maximum width limit */
        color: #fff;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.2s, visibility 0.2s;
        pointer-events: none;
        z-index: 1001;
        text-align: center;
        white-space: normal; /* Allow text to wrap */
      }

      .chat-actions-dropdown {
        overflow: visible !important; /* Override any existing overflow settings */
      }

      .tooltip::before {
        content: "";
        position: absolute;
        top: -5px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-bottom: 5px solid rgba(0, 0, 0, 0.9);
      }

      .info-icon:hover + .tooltip {
        visibility: visible;
        opacity: 1;
      }

      .muted-message {
        text-align: center;
        padding: 10px;
        background: rgba(255, 0, 0, 0.1);
        border-radius: 5px;
        margin: 10px 0;
      }

      .image-preview-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1500;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .image-preview-overlay.visible {
        display: flex;
        opacity: 1;
      }

      /* Ensure outer message container supports absolute positioning */
      .message.image-message {
        background: rgba(
          38,
          166,
          154,
          0.7
        ); /* Teal background like location message */
        border-radius: 20px; /* Rounded edges */
        padding: 8px 12px; /* Consistent padding */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Slight shadow */
        max-width: 70%; /* Limit width like other messages */
        margin: 5px 10px; /* Maintain spacing */
        display: inline-block; /* Consistent with other messages */
        overflow: hidden; /* Contain inner elements */
      }

      /* Ensure sent image messages have a distinct style */
      .message.sent.image-message {
        border-bottom-right-radius: 2px; /* Cut-off corner for sent messages */
        float: right; /* Right alignment for sent */
        text-align: left; /* Left align content */
      }

      /* Ensure received image messages have a distinct style */
      .message.received.image-message {
        border-bottom-left-radius: 5px; /* Cut-off corner for received */
        float: left; /* Left alignment for received */
        text-align: left; /* Left align content */
      }

      .message.image-message .image-bubble {
        display: inline-flex; /* Flex for aligning icon and image */
        align-items: center; /* Center icon and image vertically */
        color: #012343; /* Vibrant blue text (optional, for consistency) */
        text-decoration: none; /* No underline on the bubble itself */
        font-weight: 500; /* Medium weight */
        font-size: 14px; /* Compact */
        cursor: pointer;
        padding: 6px 12px; /* Padding inside the bubble */
        border-radius: 12px; /* Rounded corners */
        background: linear-gradient(
          135deg,
          rgba(38, 166, 154, 0.15),
          rgba(38, 166, 154, 0.05)
        ); /* Teal gradient */
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3),
          inset 0 1px 1px rgba(255, 255, 255, 0.1); /* Shadow */
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Smooth transition */
        position: relative; /* For icon positioning */
        overflow: hidden; /* For gradient effect */
        margin-bottom: 22px; /* Space before timestamp */
      }

      .message.image-message .image-bubble:hover {
        color: #ffffff; /* White text on hover */
        background: linear-gradient(
          135deg,
          rgba(38, 166, 154, 0.3),
          rgba(38, 166, 154, 0.1)
        ); /* Darker gradient on hover */
        box-shadow: 0 4px 12px rgba(38, 166, 154, 0.4),
          inset 0 1px 1px rgba(255, 255, 255, 0.2); /* Enhanced shadow */
        transform: translateY(-1px) scale(1.02); /* Slight lift and scale */
      }

      .message.image-message .image-bubble:active {
        transform: translateY(0) scale(0.98); /* Slight press effect */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Reduced shadow */
      }

      .message.image-message .image-bubble::before {
        margin-right: 6px; /* Space before image */
        font-size: 14px; /* Icon size */
        line-height: 1; /* Align with text */
        color: #fff; /* White icon */
        transition: transform 0.3s ease; /* Smooth transition for icon */
      }

      .message.image-message .image-bubble:hover::before {
        transform: scale(1.2) rotate(10deg); /* Slight rotation and scale on hover */
      }

      .message.image-message .image-bubble::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        ); /* Gradient sweep */
        transition: left 0.5s ease; /* Smooth transition */
      }

      .message.image-message .image-bubble:hover::after {
        left: 100%; /* Sweep effect */
      }

      .message.image-message .image-bubble .chat-image {
        max-width: 200px; /* Smaller max-width to fit within the bubble */
        max-height: 200px; /* Limit height */
        border-radius: 10px; /* Rounded image corners */
        object-fit: cover; /* Ensure image fits without distortion */
        display: block; /* Ensure proper rendering */
        margin: 0; /* Remove default margins */
      }

      .message.image-message .chat-image {
        max-width: 200px; /* Smaller max-width to fit within the bubble */
        max-height: 200px; /* Limit height */
        border-radius: 10px; /* Rounded image corners */
        object-fit: cover; /* Ensure image fits without distortion */
        display: block; /* Ensure proper rendering */
        margin: 0; /* Remove default margins */
      }

      .message.image-message .timestamp {
        font-size: 10px;
        color: rgb(255, 255, 255) !important;
        display: block; /* Ensure it appears on its own line */
        text-align: right; /* Align to the right */
        margin-top: 8px; /* Space below the image bubble */
        line-height: 1; /* Prevent extra height */
        position: relative; /* Keep within the message flow */
      }

      .message.image-message p {
        display: none; /* Hide default text content since it's an image */
      }

      .image-preview {
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 70%;
        padding: 8px;
        border-radius: 15px;
        background: rgba(179, 183, 185, 0.355);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 1600;
        position: absolute; /* Allow JavaScript to set position */
        margin-left: -425px;
      }

      .image-preview img {
        max-width: 300px;
        max-height: 300px;
        border-radius: 10px;
        object-fit: contain;
      }

      .image-preview.loading {
        opacity: 0.7;
        pointer-events: none;
      }

      .image-preview .loading-spinner {
        display: none;
        font-size: 16px;
        color: #fff;
        text-align: center;
        margin-top: 10px;
      }

      .image-preview.loading .loading-spinner {
        display: block;
      }

      .image-preview.loading .preview-buttons {
        display: none;
      }

      .image-preview .preview-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .image-preview .preview-buttons button {
        border-radius: 20px;
        cursor: pointer;
        border: none;
        font-size: 14px;
        margin-bottom: 8px;
        font-family: "Realtime Regular";
        transition: background-color 0.3s ease, transform 0.2s ease;
      }

      .image-preview .send-preview-btn {
        background-color: none;
        padding: 8px 24px;
        color: black;
      }

      .image-preview .send-preview-btn:hover {
        background-color: #1d8376;
        color: white;
      }

      .image-preview .cancel-preview-btn {
        background-color: none;
        padding: 8px 22px;
        color: black;
      }

      .image-preview .cancel-preview-btn:hover {
        background-color: #b02a37;
        color: white;
      }

      .message img.chat-image {
        max-width: 300px;
        max-height: 300px;
        border-radius: 10px;
        object-fit: contain;
        display: block; /* Ensure image is block-level for proper alignment */
        margin: 0; /* Remove any default margins */
      }

      .full-screen-image {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        overflow: auto;
      }
      .full-screen-image img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
      }
      .full-screen-image .close-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 30px;
        color: #fff;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease;
      }
      .full-screen-image .close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* New modal styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .modal-overlay.visible {
        display: flex;
        opacity: 1;
      }
      .modal {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        background: rgba(77, 77, 77, 0.528);
        padding: 20px;
        border-radius: 10px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        transform: scale(0.95);
        transition: transform 0.3s ease;
      }
      .modal-overlay.visible .modal {
        transform: scale(1);
      }
      .modal p {
        color: #fff;
        font-size: 16px;
        margin-bottom: 20px;
      }
      .modal button {
        padding: 10px 20px;
        transition: background-color 0.3s ease;
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border-radius: 20px;
        border: none;
        text-decoration: none;
        transition: background 0.3s;
        font-size: 8px;
        font-family: "Open Sans", sans-serif;
        display: inline-block;
        margin-top: 10px;
        position: relative;
        cursor: pointer;
      }
      .modal button:hover {
        background-color: rgba(255, 255, 255, 0.4);
      }
    </style>
  </head>
  <body>
    <div class="blur-shape red-shape"></div>
    <div class="blur-shape blue-shape"></div>

    <div class="container">
      <div class="left-sidebar">
        <div class="logo">Amourette</div>
        <div class="icons-container">
          <button class="icon-btn heart-btn" id="heart-btn">
            <i class="fas fa-heart heart-icon"></i>
          </button>
          <div class="separator"></div>
          <a href="saves.html" class="icon-btn save-btn">
            <i class="fas fa-bookmark"></i>
          </a>
        </div>
        <a href="account.html">
          <div class="profile-icon">
            <img src="" alt="Profile" id="profileImage" />
          </div>
        </a>
      </div>

      <div class="messages-list">
        <div class="custom-dropdown">
          <div class="dropdown-header" id="dropdownHeader">
            <span id="dropdownSelected">Messages</span>
            <span class="arrow"><i class="fas fa-chevron-down"></i></span>
            <div class="dropdown-items" id="dropdownItems">
              <div class="dropdown-item" data-value="efforts">Efforts</div>
            </div>
          </div>
        </div>
        <input type="text" class="search-bar" placeholder="Search" />
        <div id="messageList"></div>
      </div>

      <div class="chat-section">
        <div class="blur-container">
          <div class="chat-header">
            <div class="user-info" style="cursor: pointer" id="headerUserInfo">
              <div class="avatar">
                <img
                  src="/assets/icons/users_default.png"
                  alt="Profile photo"
                  id="headerUserPhoto"
                />
              </div>
              <div>
                <div class="name" id="headerUserName">Name</div>
                <div class="status">Active</div>
              </div>
            </div>
            <div class="actions">
              <div class="icon actions-icon" id="actionsIcon">
                <i class="fas fa-ellipsis-vertical"></i>
                <div class="chat-actions-dropdown" id="chatActionsDropdown">
                  <div class="action-item" data-action="mute">
                    <span class="action-text">Mute</span>
                    <i class="fas fa-info-circle info-icon"></i>
                    <div class="tooltip">
                      If you mute, only you can message until you unmute your
                      connection
                    </div>
                  </div>
                  <div class="action-item" data-action="clear">
                    <span class="action-text">Clear Messages</span>
                    <i class="fas fa-info-circle info-icon"></i>
                    <div class="tooltip">
                      This will clear all the messages forever
                    </div>
                  </div>
                  <div class="action-item" data-action="block">Block</div>
                  <a href="report-account.html">
                    <div class="action-item">Report</div>
                  </a>
                </div>
              </div>
            </div>
          </div>
          <div class="chat-body"></div>
          <div class="chat-footer">
            <input type="text" class="message-input" placeholder="Message" />
            <div class="send-btn">âž¤</div>
          </div>
        </div>
        <div class="efforts-container">
          <div class="efforts-content">
            <p>
              Here you can see who has bestowed a rose upon you or whispered
              sweet nothings in a comment.
            </p>
          </div>
        </div>
        <button class="plus-btn">+</button>
        <div class="options-menu">
          <button onclick="selectOption('Photo')">Photo</button>
          <button onclick="selectOption('Video')">Video</button>
          <button id="shareLocationBtn">Share Location</button>
        </div>
        <input
          type="file"
          id="photoInput"
          accept="image/*"
          style="display: none"
        />
        <div class="modal-overlay" id="errorModal">
          <div class="modal">
            <p id="modalMessage"></p>
            <button onclick="closeModal()">OK</button>
          </div>
        </div>
        <div class="image-preview-overlay" id="imagePreviewOverlay"></div>
      </div>
    </div>

    <script>
      let messagesData = [];
      let effortsData = [];
      let currentMatchId = null;
      let currentUserId = null; // Store current user's ID
      const socket = io("http://127.0.0.1:3000", {
        auth: {
          token: localStorage.getItem("jwtToken"),
        },
      });

      document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("errorModal");
        const modalButton = modal.querySelector("button");

        // Close modal when clicking the OK button
        modalButton.addEventListener("click", (e) => {
          e.stopPropagation(); // Prevent the click from bubbling to the overlay
          closeModal();
        });

        // Close modal when clicking outside the modal content
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });

        function showModal(message) {
          const modal = document.getElementById("errorModal");
          const modalMessage = document.getElementById("modalMessage");
          modalMessage.textContent = message;
          modal.classList.add("visible");
          setTimeout(() => {
            modal.style.display = "flex";
          }, 10);
        }

        function closeModal() {
          const modal = document.getElementById("errorModal");
          modal.classList.remove("visible");
          setTimeout(() => {
            modal.style.display = "none";
          }, 300);
        }

        const heartBtn = document.getElementById("heart-btn");
        if (heartBtn) {
          heartBtn.addEventListener("click", () => {
            window.location.href = "explore.html";
          });
        }

        const plusBtn = document.querySelector(".plus-btn");
        const optionsMenu = document.querySelector(".options-menu");
        const blurContainer = document.querySelector(".blur-container");
        if (plusBtn && optionsMenu && blurContainer) {
          plusBtn.addEventListener("click", () => {
            plusBtn.classList.toggle("active");
            optionsMenu.classList.toggle("active");
            optionsMenu.style.pointerEvents = optionsMenu.classList.contains(
              "active"
            )
              ? "auto"
              : "none";
            blurContainer.classList.toggle(
              "blur",
              optionsMenu.classList.contains("active")
            );
          });

          let selectedFile = null; // Store the selected file

          window.selectOption = function (option) {
            const plusBtn = document.querySelector(".plus-btn");
            const optionsMenu = document.querySelector(".options-menu");
            const blurContainer = document.querySelector(".blur-container");
            const imagePreviewOverlay = document.getElementById(
              "imagePreviewOverlay"
            );

            if (option === "Photo") {
              const photoInput = document.getElementById("photoInput");
              photoInput.click();
              photoInput.onchange = function (event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file size5 (1MB = 1 * 1024 * 1024 bytes)
                const maxSize = 1 * 1024 * 1024;
                if (file.size > maxSize) {
                  showModal("Image too large! Please select a file under 5MB.");
                  photoInput.value = "";
                  return;
                }

                selectedFile = file;

                const previewDiv = document.createElement("div");
                previewDiv.classList.add("image-preview");
                previewDiv.innerHTML = `
    <img id="previewImage" alt="Image Preview">
    <div class="loading-spinner">Converting image...</div>
    <div class="preview-buttons">
      <button class="send-preview-btn">Send</button>
      <button class="cancel-preview-btn">Cancel</button>
    </div>
  `;
                imagePreviewOverlay.appendChild(previewDiv);
                imagePreviewOverlay.classList.add("visible");

                // Center the preview in the chat-section
                const chatSection = document.querySelector(".chat-section");
                const chatSectionRect = chatSection.getBoundingClientRect();
                const previewWidth = previewDiv.offsetWidth;

                // Calculate the left position to center the preview in the chat-section
                const leftPosition =
                  chatSectionRect.left +
                  (chatSectionRect.width - previewWidth) / 2;

                previewDiv.style.position = "absolute";
                previewDiv.style.left = `${leftPosition}px`;
                previewDiv.style.top = "50%";
                previewDiv.style.transform = "translateY(-50%)";

                const previewImage = document.getElementById("previewImage");
                previewImage.src = URL.createObjectURL(file);

                const sendBtn = previewDiv.querySelector(".send-preview-btn");
                const cancelBtn = previewDiv.querySelector(
                  ".cancel-preview-btn"
                );

                sendBtn.addEventListener("click", () => {
                  if (!selectedFile || !currentMatchId) {
                    showModal(
                      "Please select a conversation to send the image."
                    );
                    previewDiv.remove();
                    imagePreviewOverlay.classList.remove("visible");
                    selectedFile = null;
                    return;
                  }

                  previewDiv.classList.add("loading");

                  const reader = new FileReader();
                  reader.onload = function (e) {
                    const base64String = e.target.result;

                    socket.emit(
                      "sendMessage",
                      {
                        matchId: currentMatchId,
                        content: base64String,
                        isImage: true,
                      },
                      (response) => {
                        if (response.success) {
                          previewDiv.remove();
                          imagePreviewOverlay.classList.remove("visible");
                          selectedFile = null;
                        } else {
                          previewDiv.classList.remove("loading");
                          showModal("Failed to send image: " + response.error);
                        }
                      }
                    );
                  };
                  reader.onerror = function () {
                    previewDiv.classList.remove("loading");
                    showModal("Error converting image to Base64.");
                  };
                  reader.readAsDataURL(selectedFile);
                });

                cancelBtn.addEventListener("click", () => {
                  previewDiv.remove();
                  imagePreviewOverlay.classList.remove("visible");
                  selectedFile = null;
                  photoInput.value = "";
                });

                plusBtn.classList.remove("active");
                optionsMenu.classList.remove("active");
                blurContainer.classList.remove("blur");
                photoInput.value = "";
              };
            } else if (option === "Video") {
              showModal("Video sharing is not supported yet.");
              plusBtn.classList.remove("active");
              optionsMenu.classList.remove("active");
              blurContainer.classList.remove("blur");
            }
          };
        }

        const profileIcon = document.querySelector(".profile-icon img");
        const storedImage = localStorage.getItem("profileImage");
        if (storedImage) profileIcon.src = storedImage;

        const dropdownHeader = document.getElementById("dropdownHeader");
        const dropdownMenu = document.getElementById("dropdownMenu");
        const dropdownSelected = document.getElementById("dropdownSelected");
        const dropdownArrow = document.querySelector(".dropdown-header .arrow");
        const messageList = document.getElementById("messageList");
        const chatBody = document.querySelector(".chat-body");
        const messageInput = document.querySelector(".message-input");
        const sendBtn = document.querySelector(".send-btn");
        const effortsContainer = document.querySelector(".efforts-container");
        const searchBar = document.querySelector(".search-bar");

        function updateDropdownItems(selectedOption) {
          dropdownItems.innerHTML = "";
          const options = ["Messages", "Efforts"].filter(
            (opt) => opt.toLowerCase() !== selectedOption.toLowerCase()
          );
          options.forEach((option) => {
            const item = document.createElement("div");
            item.classList.add("dropdown-item");
            item.setAttribute(
              "data-value",
              option.toLowerCase().replace(" ", "")
            );
            item.textContent = option;
            dropdownItems.appendChild(item);
          });
        }

        function renderMessageList(data, type) {
          messageList.innerHTML = "";
          if (data.length === 0) {
            messageList.innerHTML = `
        <div class="message-item simplified">
          <div class="name">No ${
            type === "messages" ? "matches" : "pending efforts"
          } yet.</div>
        </div>
      `;
            return;
          }

          data.forEach((item) => {
            const div = document.createElement("div");
            div.classList.add("message-item");
            if (type === "messages") {
              div.dataset.matchId = item.matchId;
              div.dataset.otherUserId = item.otherUserId;
              div.dataset.score = item.score;

              const messageContent = item.isLocation
                ? "Location was shared"
                : item.snippet;
              const truncatedMessage =
                messageContent.length > 15
                  ? messageContent.substring(0, 15) + "..."
                  : messageContent;

              div.innerHTML = `
          <div class="avatar">
            <img src="${item.photo}" alt="${item.name}'s photo">
          </div>
          <div class="details">
            <div class="name-time">
              <div class="name">${item.name}</div>
              <div class="time">${item.time}</div>
            </div>
            <div class="snippet">${truncatedMessage}</div>
          </div>
        `;
            } else {
              div.dataset.effortId = item.id;
              div.innerHTML = `
          <div class="avatar">
            <img src="${item.photo || "assets/icons/user-solid.svg"}" alt="${
                item.name
              }'s photo">
          </div>
          <div class="details">
            <div class="name">${item.name || "Unknown"}</div>
            <div class="comment">${item.comment || "No comment"}</div>
          </div>
        `;
            }
            messageList.appendChild(div);
          });

          document.querySelectorAll(".message-item").forEach((item) => {
            item.addEventListener("click", (event) => {
              if (event.target.classList.contains("remove-btn")) return;
              if (type === "messages") {
                const matchId = item.dataset.matchId;
                const name = item.querySelector(".name").textContent;
                const score = parseFloat(item.dataset.score);
                currentMatchId = matchId;
                console.log(
                  "Loading messages for matchId:",
                  matchId,
                  "with score:",
                  score
                );
                loadMessages(matchId, name, score);
              } else {
                const effortId = item.dataset.effortId;
                const effort = effortsData.find((e) => e.id === effortId);
                showEffortActions(effort);
              }
            });
          });
        }

        function updateMessageList(selectedOption) {
          messageList.innerHTML = "";
          blurContainer.style.display = "none";
          effortsContainer.style.display = "none";
          plusBtn.style.display = "none";
          optionsMenu.style.display = "none";
          const actions = document.querySelector(".chat-header .actions");
          actions.classList.remove("visible");

          const token = localStorage.getItem("jwtToken");
          if (!token) {
            messageList.innerHTML = `
        <div class="message-item simplified">
          <div class="name">Please log in to view ${selectedOption}.</div>
        </div>
      `;
            window.location.href = "login.html";
            return;
          }

          if (selectedOption.toLowerCase() === "messages") {
            blurContainer.style.display = "flex";
            plusBtn.style.display = "block";
            optionsMenu.style.display = "block";
            messageList.innerHTML = `
        <div class="message-item simplified">
          <div class="name loading">Loading<span>.</span><span>.</span><span>.</span></div>
        </div>
      `;

            fetch("http://localhost:3000/api/matches", {
              headers: { Authorization: `Bearer ${token}` },
              credentials: "include",
            })
              .then((response) => {
                if (!response.ok)
                  throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
              })
              .then((result) => {
                messagesData = result.profiles || [];
                renderMessageList(messagesData, "messages");
              })
              .catch((error) => {
                console.error("Error fetching matches:", error);
                messageList.innerHTML = `
            <div class="message-item simplified">
              <div class="name">Error loading matches: ${error.message}</div>
            </div>
          `;
              });
          } else if (selectedOption.toLowerCase() === "efforts") {
            effortsContainer.style.display = "flex";
            const effortsContent = document.querySelector(".efforts-content");
            effortsContent.innerHTML = `
        <p>Here you can see who has bestowed a rose upon you or whispered sweet nothings in a comment.</p>
      `;
            messageList.innerHTML = `
        <div class="message-item simplified">
          <div class="name loading">Loading<span>.</span><span>.</span><span>.</span></div>
        </div>
      `;

            fetch("http://localhost:3000/api/efforts", {
              headers: { Authorization: `Bearer ${token}` },
              credentials: "include",
            })
              .then((response) => {
                if (!response.ok)
                  throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
              })
              .then((result) => {
                effortsData = result.efforts || [];
                renderMessageList(effortsData, "efforts");
              })
              .catch((error) => {
                console.error("Error fetching efforts:", error);
                messageList.innerHTML = `
            <div class="message-item simplified">
              <div class="name">Error loading efforts: ${error.message}</div>
            </div>
          `;
              });
          }
        }

        if (dropdownHeader && dropdownItems) {
          // Wrap the title and arrow in a top-row div
          const topRow = document.createElement("div");
          topRow.classList.add("top-row");
          topRow.appendChild(dropdownSelected);
          topRow.appendChild(dropdownArrow);
          dropdownHeader.insertBefore(topRow, dropdownItems);

          dropdownHeader.addEventListener("click", () => {
            dropdownHeader.classList.toggle("active");
            dropdownArrow.classList.toggle("active");
          });

          dropdownItems.addEventListener("click", (event) => {
            const selectedValue = event.target.getAttribute("data-value");
            const selectedText = event.target.textContent;
            dropdownSelected.textContent = selectedText;
            dropdownHeader.classList.remove("active");
            dropdownArrow.classList.remove("active");
            updateDropdownItems(selectedText);
            updateMessageList(selectedValue);
            searchBar.value = "";
            filterMessageList("");
          });

          document.addEventListener("click", (event) => {
            if (!dropdownHeader.contains(event.target)) {
              dropdownHeader.classList.remove("active");
              dropdownArrow.classList.remove("active");
            }
          });

          updateDropdownItems("Messages");
          updateMessageList("messages");
        }

        function filterMessageList(query) {
          const selectedOption = dropdownSelected.textContent.toLowerCase();
          const data =
            selectedOption === "messages" ? messagesData : effortsData;
          const filteredData = data.filter((item) =>
            item.name.toLowerCase().includes(query.toLowerCase())
          );
          renderMessageList(filteredData, selectedOption);
        }

        searchBar.addEventListener("input", (e) =>
          filterMessageList(e.target.value.trim())
        );

        function showEffortActions(effort) {
          const effortsContent = document.querySelector(".efforts-content");
          effortsContent.innerHTML = `
      <div class="efforts-message">
        <p class="comment-text">"${effort.comment || "No comment"}"</p>
        <span class="timestamp">${new Date().toLocaleTimeString([], {
          hour: "numeric",
          minute: "2-digit",
        })}</span>
      </div>
      <p>${effort.name} sent you a rose!</p>
      <div class="efforts-actions">
        <button class="accept-btn" data-id="${effort.id}">Accept</button>
        <button class="reject-btn" data-id="${effort.id}">Decline</button>
      </div>
    `;

          effortsContent
            .querySelector(".accept-btn")
            .addEventListener("click", () => handleAccept(effort));
          effortsContent
            .querySelector(".reject-btn")
            .addEventListener("click", () => handleDecline(effort.id));
        }

        async function handleAccept(effort) {
          const token = localStorage.getItem("jwtToken");
          if (!token) {
            alert("Please log in to accept efforts.");
            window.location.href = "login.html";
            return;
          }

          try {
            const response = await fetch(
              `http://localhost:3000/api/efforts/${effort.id}/accept`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
              }
            );
            if (!response.ok)
              throw new Error(`Failed to accept effort: ${response.status}`);
            const result = await response.json();
            effortsData = effortsData.filter((e) => e.id !== effort.id);
            messagesData.push(result.match);
            dropdownSelected.textContent = "Messages";
            dropdownMenu.classList.remove("active");
            dropdownArrow.classList.remove("active");
            updateDropdownOptions("Messages");
            await updateMessageList("messages");
            const newMatchItem = document.querySelector(
              `.message-item[data-match-id="${result.match.matchId}"]`
            );
            if (newMatchItem) newMatchItem.click();
          } catch (error) {
            console.error("Error accepting effort:", error);
            alert("Something went wrong: " + error.message);
          }
        }

        async function handleDecline(effortId) {
          const token = localStorage.getItem("jwtToken");
          if (!token) {
            alert("Please log in to decline efforts.");
            window.location.href = "login.html";
            return;
          }

          try {
            const response = await fetch(
              `http://localhost:3000/api/efforts/${effortId}`,
              {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` },
              }
            );
            if (!response.ok)
              throw new Error(`Failed to decline effort: ${response.status}`);
            effortsData = effortsData.filter((e) => e.id !== effortId);
            updateMessageList("efforts");
            document.querySelector(".efforts-content").innerHTML = `
        <p>Here you can see who has bestowed a rose upon you or whispered sweet nothings in a comment.</p>
      `;
          } catch (error) {
            console.error("Error declining effort:", error);
            alert("Something went wrong while declining the effort.");
          }
        }

        if (dropdownHeader && dropdownMenu) {
          dropdownHeader.addEventListener("click", () => {
            dropdownMenu.classList.toggle("active");
            dropdownArrow.classList.toggle("active");
          });

          dropdownMenu.addEventListener("click", (event) => {
            const selectedValue = event.target.getAttribute("data-value");
            const selectedText = event.target.textContent;
            dropdownSelected.textContent = selectedText;
            dropdownMenu.classList.remove("active");
            dropdownArrow.classList.remove("active");
            updateDropdownOptions(selectedText);
            updateMessageList(selectedValue);
            searchBar.value = "";
            filterMessageList("");
          });

          document.addEventListener("click", (event) => {
            if (
              !dropdownHeader.contains(event.target) &&
              !dropdownMenu.contains(event.target)
            ) {
              dropdownMenu.classList.remove("active");
              dropdownArrow.classList.remove("active");
            }
          });

          updateDropdownOptions("Messages");
          updateMessageList("messages");
        }

        const actionsIcon = document.getElementById("actionsIcon");
        const chatActionsDropdown = document.getElementById(
          "chatActionsDropdown"
        );
        if (actionsIcon && chatActionsDropdown) {
          actionsIcon.addEventListener("click", (event) => {
            event.stopPropagation();
            chatActionsDropdown.classList.toggle("active");
          });

          document.querySelectorAll(".action-item").forEach((item) => {
            item.addEventListener("click", (event) => {
              event.stopPropagation();
              const action = item.getAttribute("data-action");
              handleChatAction(action);
              chatActionsDropdown.classList.remove("active");
            });
          });

          document.addEventListener("click", (event) => {
            if (
              !actionsIcon.contains(event.target) &&
              !chatActionsDropdown.contains(event.target)
            ) {
              chatActionsDropdown.classList.remove("active");
            }
          });
        }

        function handleChatAction(action) {
          const actionItem = document.querySelector('[data-action="mute"]');
          const actionText = actionItem.querySelector(".action-text");
          const headerUserInfo = document.getElementById("headerUserInfo");
          const otherUserId = headerUserInfo.dataset.otherUserId;

          switch (action) {
            case "mute":
              if (actionText.textContent === "Mute") {
                socket.emit(
                  "muteUser",
                  { matchId: currentMatchId, mutedId: otherUserId },
                  (response) => {
                    if (!response.success)
                      console.error("Failed to mute user:", response.error);
                  }
                );
              } else {
                socket.emit(
                  "unmuteUser",
                  { matchId: currentMatchId, mutedId: otherUserId },
                  (response) => {
                    if (!response.success)
                      console.error("Failed to unmute user:", response.error);
                  }
                );
              }
              break;
            case "clear":
              clearMessages(currentMatchId);
              break;
            case "block":
              blockUser(currentMatchId);
              break;
            default:
              console.log("Unknown action:", action);
          }
        }

        async function clearMessages(matchId) {
          const token = localStorage.getItem("jwtToken");
          if (!token) {
            alert("Please log in to clear messages.");
            window.location.href = "login.html";
            return;
          }

          try {
            // Fetch the user's profile to get their first name
            let firstName = "You"; // Fallback in case fetching fails
            try {
              const profileResponse = await fetch(
                "http://localhost:3000/api/profile",
                {
                  headers: { Authorization: `Bearer ${token}` },
                  credentials: "include",
                }
              );
              const profileData = await profileResponse.json();
              if (profileResponse.ok && profileData.firstName) {
                firstName = profileData.firstName;
              }
            } catch (error) {
              console.warn("Failed to fetch user profile for name:", error);
            }

            // Send DELETE request to clear messages
            const response = await fetch(
              `http://localhost:3000/api/messages/${matchId}/clear`,
              {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` },
                credentials: "include",
              }
            );
            const result = await response.json();
            if (!response.ok) {
              throw new Error(
                result.message || `Failed to clear messages: ${response.status}`
              );
            }

            // Format the date (e.g., "April 17, 2025")
            const now = new Date();
            const dateString = now.toLocaleDateString("en-US", {
              month: "long",
              day: "numeric",
              year: "numeric",
            });

            // Update the chat body with the new message
            const chatBody = document.querySelector(".chat-body");
            chatBody.innerHTML = `
      <p class="chat-cleared-message">
        Chat was cleared by ${firstName} on ${dateString}
      </p>
    `;

            // Update the message list snippet to reflect the cleared state
            const messageItem = document.querySelector(
              `.message-item[data-match-id="${matchId}"]`
            );
            if (messageItem) {
              messageItem.querySelector(".snippet").textContent = "No messages";
              messageItem.querySelector(".time").textContent = "";
            }
          } catch (error) {
            console.error("Error clearing messages:", error);
            alert("Failed to clear messages: " + error.message);
          }
        }

        socket.on("clearMessages", async ({ matchId }, callback) => {
          try {
            const userId = socket.userId; // Assuming userId is set during socket authentication
            const match = await Like.findOne({
              _id: matchId,
              $or: [{ userId }, { profileId: userId }],
              status: "matched",
            });

            if (!match) {
              const roseMatch = await RoseInteraction.findOne({
                _id: matchId,
                $or: [{ fromUser: userId }, { toUser: userId }],
                status: "accepted",
              });
              if (!roseMatch) {
                return callback({
                  success: false,
                  error: "Match not found or unauthorized",
                });
              }
            }

            const result = await Message.deleteMany({ matchId });
            callback({ success: true, deletedCount: result.deletedCount });
          } catch (error) {
            console.error("Error clearing messages via socket:", error);
            callback({ success: false, error: "Server error" });
          }
        });

        async function blockUser(matchId) {
          const token = localStorage.getItem("jwtToken");
          if (!token) {
            alert("Please log in to block users.");
            window.location.href = "login.html";
            return;
          }

          try {
            const response = await fetch(
              `http://localhost:3000/api/block/${matchId}`,
              {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` },
                credentials: "include",
              }
            );
            const result = await response.json();
            if (!response.ok) {
              throw new Error(
                result.message || `Failed to block user: ${response.status}`
              );
            }
            console.log("Block response:", result);

            messagesData = messagesData.filter((m) => m.matchId !== matchId);
            renderMessageList(messagesData, "messages");

            if (currentMatchId === matchId) {
              chatBody.innerHTML = "<p>User blocked and chat cleared.</p>";
              document
                .querySelector(".chat-header .actions")
                .classList.remove("visible");
            }
          } catch (error) {
            console.error("Error blocking user:", error);
            alert("Failed to block user: " + error.message);
          }
        }

        // Add this helper function to update status
        function updateUserStatus(userId, status) {
          const headerUserInfo = document.getElementById("headerUserInfo");
          const statusElement = document.querySelector(
            ".chat-header .user-info .status"
          );
          const currentOtherUserId = headerUserInfo.dataset.otherUserId;

          if (currentOtherUserId && userId === currentOtherUserId) {
            statusElement.textContent =
              status === "online" ? "Active" : "Offline";
            statusElement.classList.remove("default");
          } else if (!currentOtherUserId) {
            statusElement.textContent = "default";
            statusElement.classList.add("default");
          }
        }

        async function loadMessages(matchId, name, score) {
          const chatHeaderName = document.querySelector(".chat-header .name");
          const chatHeaderAvatar = document.querySelector(
            ".chat-header .user-info .avatar"
          );
          const headerUserInfo = document.getElementById("headerUserInfo");
          const actions = document.querySelector(".chat-header .actions");
          const statusElement = document.querySelector(
            ".chat-header .user-info .status"
          );

          actions.classList.add("visible");
          chatBody.innerHTML = "<p>Loading messages...</p>";
          chatHeaderName.textContent = name;

          const match = messagesData.find((m) => m.matchId === matchId);
          if (match) {
            chatHeaderAvatar.innerHTML = `<img src="${match.photo}" alt="${name}'s photo">`;
            headerUserInfo.dataset.otherUserId = match.otherUserId;

            // Set default status initially
            statusElement.textContent = "default";

            // Query initial status
            if (match.otherUserId) {
              socket.emit(
                "getUserStatus",
                { userId: match.otherUserId },
                (response) => {
                  if (response && response.status) {
                    updateUserStatus(response.userId, response.status);
                  } else {
                    statusElement.textContent = "default"; // Fallback for errors
                  }
                }
              );
            }

            socket.emit("loadMessages", matchId, (response) => {
              if (response.success) {
                chatBody.innerHTML = "";
                const messages = response.messages;

                if (messages.length === 0) {
                  if (score >= 6.6) {
                    let funLine, kinkLine;
                    if (score >= 6.6 && score <= 7.5) {
                      funLine = "Sparks are starting to fly!";
                      kinkLine = "A little twist makes it interesting!";
                    } else if (score > 7.5 && score <= 8.5) {
                      funLine = "You're vibing like a perfect playlist!";
                      kinkLine = "There's a spicy edge to this connection!";
                    } else if (score > 8.5) {
                      funLine = "Match made in cosmic harmony!";
                      kinkLine = "This bond's got some wild chemistry!";
                    }
                    chatBody.innerHTML = `
                <div class="score-info" id="match-score">
                  <p>Your match score: ${score.toFixed(1)}</p>
                  <p class="fun-line">${funLine}</p>
                  <p class="kink-line">${kinkLine}</p>
                </div>
              `;
                  }
                } else {
                  messages.forEach(appendMessage);
                }
              } else {
                console.error("Error loading messages:", response.error);
                chatBody.innerHTML = "<p>Error loading messages</p>";
              }
            });
          } else {
            statusElement.textContent = "default"; // Fallback if match not found
          }

          // Enable the message input and show buttons when a user is selected
          messageInput.disabled = false;
          plusBtn.style.display = "block";
          sendBtn.style.display = "block";
        }

        function sendMessage() {
          const content = messageInput.value.trim();
          if (!content || !currentMatchId) return;

          const isLocationMessage = content.startsWith("Location: ");

          // Check if the chat body contains the cleared message and clear it
          const chatBody = document.querySelector(".chat-body");
          if (chatBody.querySelector(".chat-cleared-message")) {
            chatBody.innerHTML = "";
          }

          socket.emit(
            "sendMessage",
            {
              matchId: currentMatchId,
              content: content,
              isLocation: isLocationMessage,
            },
            (response) => {
              if (response.success) {
                messageInput.value = "";
              } else {
                console.error("Error sending message:", response.error);
                alert("Failed to send message: " + response.error);
              }
            }
          );
        }

        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") sendMessage();
        });

        socket.on("connect", () => {
          console.log("Connected to Socket.IO server!");
          currentUserId = JSON.parse(localStorage.getItem("user"))?._id;
          socket.emit("joinMatches", (response) => {
            if (response.success) {
              console.log("Joined match rooms:", response.matchIds);
            } else {
              console.error("Failed to join matches:", response.error);
            }
          });

          // Listen for user status updates
          socket.on("userStatusUpdate", ({ userId, status }) => {
            updateUserStatus(userId, status);
          });
        });

        socket.on("newMatch", (matchData) => {
          console.log("New match received:", matchData);
          if (!messagesData.some((m) => m.matchId === matchData.matchId)) {
            messagesData.push(matchData);
            renderMessageList(messagesData, "messages");
            if (dropdownSelected.textContent.toLowerCase() === "messages") {
              const newMatchItem = document.querySelector(
                `.message-item[data-match-id="${matchData.matchId}"]`
              );
              if (newMatchItem) newMatchItem.click();
            }
          }
        });

        socket.on("new-message", (message) => {
          if (message.matchId === currentMatchId) {
            const chatBody = document.querySelector(".chat-body");
            // Remove the cleared message or match score if present
            if (
              chatBody.querySelector(".chat-cleared-message") ||
              chatBody.querySelector("#match-score")
            ) {
              chatBody.innerHTML = "";
            }
            appendMessage(message);
          }
          const messageItem = document.querySelector(
            `.message-item[data-match-id="${message.matchId}"]`
          );
          if (messageItem) {
            const isLocationMessage = message.isLocation;
            const messageContent = isLocationMessage
              ? "Location was shared"
              : message.content;
            const truncatedMessage =
              messageContent.length > 15
                ? messageContent.substring(0, 15) + "..."
                : messageContent;

            messageItem.querySelector(".snippet").textContent =
              truncatedMessage;
            messageItem.querySelector(".time").textContent = new Date(
              message.createdAt
            ).toLocaleTimeString([], {
              hour: "numeric",
              minute: "2-digit",
            });
          }
        });

        socket.on("messageDeleted", ({ messageId, content }) => {
          const message = document.querySelector(
            `.message[data-message-id="${messageId}"]`
          );
          if (message) {
            // Remove existing content (image or text)
            message.innerHTML = `
      <div class="message-reaction"></div>
      <p class="deleted-message">${content}</p>
      <span class="timestamp">${new Date().toLocaleTimeString([], {
        hour: "numeric",
        minute: "2-digit",
      })}</span>
    `;
            message.classList.remove("image-message"); // Remove image-message class
          }
        });

        socket.on("messageReaction", ({ messageId, emoji }) => {
          const message = document.querySelector(
            `.message[data-message-id="${messageId}"]`
          );
          if (message) {
            const reactionDiv = message.querySelector(".message-reaction");
            reactionDiv.textContent = emoji;
          }
        });

        socket.on("userMuted", (data) => {
          if (data.matchId === currentMatchId) {
            updateChatUIForMuteStatus({
              isMuted: true,
              isMuter: data.muterId === currentUserId,
              mutedId: data.mutedId,
              muterId: data.muterId,
            });
          }
        });

        socket.on("userUnmuted", (data) => {
          if (data.matchId === currentMatchId) {
            updateChatUIForMuteStatus({
              isMuted: false,
              isMuter: false,
              mutedId: data.mutedId,
              muterId: data.muterId,
            });
          }
        });

        const contextMenu = document.createElement("div");
        contextMenu.className = "message-context-menu";
        document.body.appendChild(contextMenu);

        const emojiPanel = document.createElement("div");
        emojiPanel.className = "emoji-reaction-panel";
        emojiPanel.innerHTML = `
    <div class="emoji-option">â¤ï¸</div>
    <div class="emoji-option">ðŸ˜‚</div>
    <div class="emoji-option">ðŸ‘</div>
    <div class="emoji-option">ðŸ˜®</div>
    <div class="emoji-option">ðŸ˜¢</div>
    <div class="emoji-option">ðŸ™</div>
  `;
        document.body.appendChild(emojiPanel);

        let activeMessage = null;
        const longPressDuration = 500;

        function showContextMenu(message, x, y) {
          const chatBody = document.querySelector(".chat-body");
          const allMessages = chatBody.querySelectorAll(".message");
          allMessages.forEach((msg) => msg.classList.remove("active-message"));
          message.classList.add("active-message");
          chatBody.classList.add("blur");

          const rect = message.getBoundingClientRect();
          const viewportWidth = window.innerWidth;
          const viewportHeight = window.innerHeight;
          const menuWidth = contextMenu.offsetWidth || 150;
          const menuHeight = contextMenu.offsetHeight || 100;
          const gap = 10;

          const isSender = message.classList.contains("sent");
          const isImageMessage = message.classList.contains("image-message");
          if (isSender && isImageMessage) {
            contextMenu.innerHTML = `
      <div class="context-menu-option" data-action="download"><i class="fas fa-download"></i>Download</div>
      <div class="context-menu-option" data-action="delete"><i class="fas fa-trash"></i>Delete</div>
    `;
          } else {
            contextMenu.innerHTML = isSender
              ? `
        <div class="context-menu-option" data-action="copy"><i class="fas fa-copy"></i>Copy</div>
        <div class="context-menu-option" data-action="delete"><i class="fas fa-trash"></i>Delete</div>
      `
              : `
        <div class="context-menu-option" data-action="copy"><i class="fas fa-copy"></i>Copy</div>
        <div class="context-menu-option" data-action="react"><i class="fas fa-smile"></i>React</div>
      `;
          }

          let posX = isSender ? rect.left - menuWidth - gap : rect.right + gap;
          if (posX < gap) posX = rect.right + gap;
          if (posX + menuWidth > viewportWidth - gap)
            posX = rect.left - menuWidth - gap;
          let posY = rect.top + rect.height / 2 - menuHeight / 2;
          posX = Math.max(gap, Math.min(posX, viewportWidth - menuWidth - gap));
          posY = Math.max(
            gap,
            Math.min(posY, viewportHeight - menuHeight - gap)
          );

          contextMenu.style.display = "block";
          contextMenu.style.left = `${posX}px`;
          contextMenu.style.top = `${posY}px`;
          contextMenu.classList.add("visible");
          activeMessage = message;
        }

        function hideContextMenu() {
          const chatBody = document.querySelector(".chat-body");
          chatBody.classList.remove("blur");
          contextMenu.classList.remove("visible");
          emojiPanel.classList.remove("visible");
          setTimeout(() => {
            contextMenu.style.display = "none";
            emojiPanel.style.display = "none";
          }, 200);
          activeMessage = null;
        }

        function showEmojiPanel() {
          const contextMenuRect = contextMenu.getBoundingClientRect();
          let posX = contextMenuRect.left;
          let posY = contextMenuRect.bottom + 5;
          const viewportWidth = window.innerWidth;
          const viewportHeight = window.innerHeight;

          if (posX + emojiPanel.offsetWidth > viewportWidth - 10)
            posX = viewportWidth - emojiPanel.offsetWidth - 10;
          if (posY + emojiPanel.offsetHeight > viewportHeight - 10)
            posY = contextMenuRect.top - emojiPanel.offsetHeight - 5;

          emojiPanel.style.display = "grid";
          emojiPanel.style.left = `${posX}px`;
          emojiPanel.style.top = `${posY}px`;
          emojiPanel.classList.add("visible");
        }

        contextMenu.addEventListener("click", (e) => {
          const action = e.target.closest(".context-menu-option")?.dataset
            .action;
          if (!action || !activeMessage) return;

          const messageId = activeMessage.dataset.messageId;
          const messageText =
            activeMessage.querySelector("p")?.textContent || "";

          switch (action) {
            case "copy":
              navigator.clipboard.writeText(messageText);
              hideContextMenu();
              break;
            case "react":
              showEmojiPanel();
              break;
            case "delete":
              socket.emit("deleteMessage", { messageId }, (response) => {
                if (!response.success)
                  alert(response.error || "Failed to delete message");
              });
              hideContextMenu();
              break;
            case "download":
              const image = activeMessage.querySelector(".chat-image");
              if (image) {
                const url = image.src;
                const link = document.createElement("a");
                link.href = url;
                link.download = `image_${messageId}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              }
              hideContextMenu();
              break;
          }
        });

        emojiPanel.addEventListener("click", (e) => {
          const emoji = e.target.textContent;
          if (!emoji || !activeMessage) return;

          const messageId = activeMessage.dataset.messageId;
          socket.emit(
            "addReaction",
            { messageId, emoji, matchId: currentMatchId },
            (response) => {
              if (!response.success)
                alert(response.error || "Failed to add reaction");
            }
          );
          hideContextMenu();
        });

        function appendMessage(message) {
          const messageDiv = document.createElement("div");
          const isSender = message.senderId._id === currentUserId;
          messageDiv.classList.add("message", isSender ? "sent" : "received");
          messageDiv.dataset.messageId = message._id;

          // Add image-message class for image messages
          if (message.isImage) {
            messageDiv.classList.add("image-message");
          }

          let content;
          if (message.isDeleted) {
            content = `<p class="deleted-message">This message was deleted</p>`;
          } else if (message.isImage) {
            content = `<div class="image-bubble"><img class="chat-image" src="${message.content}" alt="Shared image"></div>`;
          } else {
            const urlMatch = message.content.match(
              /https:\/\/www\.google\.com\/maps\/@[-?\d.]+,[-?\d.]+(?:,\d+z)?/
            );
            if (message.isLocation || urlMatch) {
              const url = urlMatch
                ? urlMatch[0]
                : "https://www.google.com/maps";
              content = `<p><a href="${url}" target="_blank" rel="noopener noreferrer" class="location-link"><span class="link-text">View Location on Google Maps</span></a></p>`;
            } else {
              content = `<p>${message.content}</p>`;
            }
          }

          messageDiv.innerHTML = `
    <div class="message-reaction">${message.reaction || ""}</div>
    ${content}
    <span class="timestamp">${new Date(message.createdAt).toLocaleTimeString(
      [],
      {
        hour: "numeric",
        minute: "2-digit",
      }
    )}</span>
  `;

          if (!message.isDeleted) {
            messageDiv.addEventListener("dblclick", (e) => {
              e.preventDefault();
              e.stopPropagation();
              if (e.target.tagName !== "A" && !e.target.closest("a")) {
                contextMenu.style.display === "block"
                  ? hideContextMenu()
                  : showContextMenu(messageDiv, e.pageX, e.pageY);
              }
            });

            const link = messageDiv.querySelector(".location-link");
            if (link) {
              link.addEventListener("click", (e) => {
                console.log("Location link clicked:", link.href);
              });
            }

            const image = messageDiv.querySelector(".chat-image");
            if (image) {
              image.addEventListener("click", () => {
                const fullScreenDiv = document.createElement("div");
                fullScreenDiv.classList.add("full-screen-image");
                fullScreenDiv.innerHTML = `
            <img src="${message.content}" alt="Full-screen image">
            <button class="close-btn">Ã—</button>
          `;
                document.body.appendChild(fullScreenDiv);

                const closeBtn = fullScreenDiv.querySelector(".close-btn");
                closeBtn.addEventListener("click", () => {
                  fullScreenDiv.remove();
                });

                fullScreenDiv.addEventListener("click", (e) => {
                  if (e.target === fullScreenDiv) {
                    fullScreenDiv.remove();
                  }
                });
              });
            }

            let touchStartTime, touchStartX, touchStartY;
            messageDiv.addEventListener("touchstart", (e) => {
              touchStartTime = Date.now();
              touchStartX = e.touches[0].pageX;
              touchStartY = e.touches[0].pageY;
              setTimeout(() => {
                if (e.target.tagName !== "A" && !e.target.closest("a")) {
                  showContextMenu(messageDiv, touchStartX, touchStartY);
                }
              }, longPressDuration);
            });
            messageDiv.addEventListener("touchend", () => clearTimeout());
            messageDiv.addEventListener("touchmove", () => clearTimeout());
          }

          chatBody.appendChild(messageDiv);
          chatBody.scrollTop = chatBody.scrollHeight;
        }

        document.addEventListener("click", (e) => {
          if (
            !e.target.closest(".message-context-menu") &&
            !e.target.closest(".emoji-reaction-panel") &&
            !e.target.closest(".message")
          ) {
            hideContextMenu();
          }
        });

        function updateChatUIForMuteStatus(muteStatus) {
          const chatFooter = document.querySelector(".chat-footer");
          const actionItem = document.querySelector('[data-action="mute"]');
          const actionText = actionItem.querySelector(".action-text");

          if (muteStatus.isMuted && !muteStatus.isMuter) {
            chatFooter.innerHTML =
              '<p class="muted-message">You were muted, so you\'re not allowed to message anymore to this connection</p>';
            chatFooter.style.justifyContent = "center";
            chatFooter.style.color = "rgba(255, 255, 255, 0.6)";
          } else if (chatFooter.querySelector(".muted-message")) {
            chatFooter.innerHTML = `
        <input type="text" class="message-input" placeholder="Message" />
        <div class="send-btn">âž¤</div>
      `;
            const newMessageInput = chatFooter.querySelector(".message-input");
            const newSendBtn = chatFooter.querySelector(".send-btn");
            newSendBtn.addEventListener("click", sendMessage);
            newMessageInput.addEventListener("keypress", (e) => {
              if (e.key === "Enter") sendMessage();
            });
          }

          actionText.textContent =
            muteStatus.isMuted && muteStatus.isMuter ? "Unmute" : "Mute";
          actionItem.style.opacity =
            muteStatus.isMuted && !muteStatus.isMuter ? "0.5" : "1";
          actionItem.style.pointerEvents =
            muteStatus.isMuted && !muteStatus.isMuter ? "none" : "auto";
        }

        async function fetchAndUpdateProfilePhoto() {
          const profileIcon = document.querySelector(".profile-icon img");
          const token = localStorage.getItem("jwtToken");
          if (!token) {
            profileIcon.src = "http://localhost:3000/default-profile.jpg";
            return;
          }

          try {
            const response = await fetch("http://localhost:3000/api/profile", {
              headers: { Authorization: `Bearer ${token}` },
              credentials: "include",
            });
            if (!response.ok) throw new Error("Failed to fetch profile");
            const userData = await response.json();
            const photoUrl =
              userData.photos?.[0] ||
              "http://localhost:3000/default-profile.jpg";
            profileIcon.src = photoUrl;
            localStorage.setItem("profileImage", photoUrl);
          } catch (error) {
            console.error("Error fetching profile photo:", error);
            profileIcon.src = "http://localhost:3000/default-profile.jpg";
          }
        }

        fetchAndUpdateProfilePhoto();

        document
          .getElementById("headerUserInfo")
          .addEventListener("click", function () {
            const otherUserId = this.dataset.otherUserId;
            if (otherUserId)
              window.location.href = `profile.html?id=${otherUserId}`;
          });

        function shareLocation() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const { latitude, longitude } = position.coords;
                const locationMessage = `Location: <a href="https://www.google.com/maps/@${latitude},${longitude}" target="_blank" rel="noopener noreferrer">View Location on Google Maps</a>`;

                const blurContainer = document.querySelector(".blur-container");
                blurContainer.classList.remove("blur");

                const optionsMenu = document.querySelector(".options-menu");
                optionsMenu.classList.remove("active");
                optionsMenu.style.pointerEvents = "none";

                const plusBtn = document.querySelector(".plus-btn");
                plusBtn.classList.remove("active");

                if (!currentMatchId) {
                  alert("Please select a conversation to share your location.");
                  return;
                }

                socket.emit(
                  "sendMessage",
                  {
                    matchId: currentMatchId,
                    content: locationMessage,
                    isLocation: true,
                  },
                  (response) => {
                    if (response.success) {
                      const messageItem = document.querySelector(
                        `.message-item[data-match-id="${currentMatchId}"]`
                      );
                      if (messageItem) {
                        messageItem.querySelector(".snippet").textContent =
                          "Location was shared";
                        messageItem.querySelector(".time").textContent =
                          new Date().toLocaleTimeString([], {
                            hour: "numeric",
                            minute: "2-digit",
                          });
                      }
                    } else {
                      console.error("Error sending location:", response.error);
                      alert("Failed to share location: " + response.error);
                    }
                  }
                );

                const messageInput = document.querySelector(".message-input");
                messageInput.value = "";
              },
              (error) => {
                console.error("Error getting location:", error);
                alert(
                  "Unable to retrieve your location. Please allow location access."
                );
              }
            );
          } else {
            alert("Geolocation is not supported by this browser.");
          }
        }

        document
          .getElementById("shareLocationBtn")
          .addEventListener("click", shareLocation);

        addStyleToHead();

        // Disable the message input and hide buttons initially
        messageInput.disabled = true; // Disable input
        plusBtn.style.display = "none"; // Hide plus button
        sendBtn.style.display = "none"; // Hide send button
      });

      function addStyleToHead() {
        const style = document.createElement("style");
        style.textContent = `
    .chat-body.blur > *:not(.active-message) { filter: blur(3px); transition: filter 0.3s ease; }
    .active-message { position: relative; z-index: 2; }
    .deleted-message { font-style: italic; color: rgba(255, 255, 255, 0.5); }
  `;
        document.head.appendChild(style);
      }
    </script>
  </body>
</html>
